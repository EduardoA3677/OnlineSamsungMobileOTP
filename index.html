<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTP de SecureKim</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
            flex-direction: column;
            text-align: center;
            position: relative;
        }
        .container {
            background-color: white;
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
        }
        h1 {
            color: #333;
            margin-bottom: 5px;
        }
        h1 a {
            color: #007bff;
            text-decoration: underline;
        }
        h1 a:hover {
            color: #0056b3;
        }
        .info-text {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.4;
            word-break: keep-all;
        }
        input[type="text"] {
            padding: 0.5em;
            font-size: 1em;
            margin-bottom: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: calc(100% - 1em);
            box-sizing: border-box;
        }
        button {
            padding: 0.7em 1.5em;
            font-size: 1em;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
        }
        button:hover {
            background-color: #0056b3;
        }
        #otpOutput {
            margin-top: 1.5em;
            font-size: 1.5em;
            font-weight: bold;
            color: #28a745;
            word-break: break-all;
            display: none;
        }
        .messageBox {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform: translateY(100%);
            z-index: 1000;
        }
        .messageBox.show {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><a href="https://blog.securekim.com" target="_blank">SecureKim</a>'s OTP</h1>
        <p class="info-text">
            Para teléfonos Samsung, marca *#9900* e ingresa el OTP para acceder a funciones secretas como captura de paquetes!<br><br>
            For Samsung phones, dial *#9900* and enter the OTP to access secret functions like packet capture!
        </p>
        <p>Ingresa una clave de 8 dígitos en el campo de abajo para generar el OTP.</p>
        <input type="text" id="inputKey" maxlength="8" placeholder="Clave de 8 dígitos (ej: 01261302)">
        <button onclick="generateOTP()">Generar OTP</button>
        <p id="otpOutput">OTP generado: </p>
    </div>

    <div id="messageBox" class="messageBox">
        ¡Generación completada!
    </div>

    <script>
        // Constants from the Python implementation
        const SECRET_HEX = "120395F099840593405B03838449A72933484040A3034750C0403938290A293B";
        const INTERVAL = 300; // 5 minutes
        const CODE_DIGITS = 6;

        // HMAC-SHA256 implementation for browsers
        async function hmacSHA256(key, message) {
            const keyBuffer = typeof key === 'string' ? hexToBytes(key) : key;
            const messageBuffer = typeof message === 'string' ? hexToBytes(message) : message;
            
            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                keyBuffer,
                { name: 'HMAC', hash: 'SHA-256' },
                false,
                ['sign']
            );
            
            const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageBuffer);
            return new Uint8Array(signature);
        }

        function hexToBytes(hex) {
            const bytes = new Uint8Array(hex.length / 2);
            for (let i = 0; i < hex.length; i += 2) {
                bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
            }
            return bytes;
        }

        function isNumeric(str) {
            return /^\d+$/.test(str);
        }

        async function generateTOTPNonce(counterHex, nonce) {
            let inputStr;
            
            // Build input string - following Python logic
            if (isNumeric(nonce) && nonce.length === 6) {
                inputStr = (nonce + counterHex).padStart(22, '0');
            } else {
                console.log("wrong nonce error");
                inputStr = counterHex.padStart(16, '0');
            }

            const hmacHash = await hmacSHA256(SECRET_HEX, inputStr);
            const offset = hmacHash[hmacHash.length - 1] & 0x0F;

            const code = (
                ((hmacHash[offset] & 0x7F) << 24) |
                ((hmacHash[offset + 1] & 0xFF) << 16) |
                ((hmacHash[offset + 2] & 0xFF) << 8) |
                (hmacHash[offset + 3] & 0xFF)
            ) % Math.pow(10, CODE_DIGITS);

            return code.toString().padStart(CODE_DIGITS, '0');
        }

        async function genOTP6DigitNonce(inputStr) {
            const nonce = inputStr ? inputStr.substring(2) : "";
            const currentTime = Math.floor(Date.now() / 1000);
            console.log(`The current UTC time is ${currentTime}`);
            
            const counter = Math.floor(currentTime / INTERVAL);
            const counterHex = counter.toString(16).toUpperCase().padStart(16, '0');

            const otp = await generateTOTPNonce(counterHex, nonce);
            console.log(`final OTP: ${otp}`);
            return otp;
        }

        function showCompletionMessage() {
            const messageBox = document.getElementById('messageBox');
            messageBox.classList.add('show');

            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        async function generateOTP() {
            const inputKey = document.getElementById("inputKey").value;

            if (!inputKey || inputKey.length !== 8) {
                document.getElementById("otpOutput").innerText = `OTP generado: La clave debe tener exactamente 8 dígitos.`;
                document.getElementById("otpOutput").style.display = 'block';
                return;
            }

            if (!isNumeric(inputKey)) {
                document.getElementById("otpOutput").innerText = `OTP generado: La clave debe contener solo números.`;
                document.getElementById("otpOutput").style.display = 'block';
                return;
            }

            try {
                const otpValue = await genOTP6DigitNonce(inputKey);
                document.getElementById("otpOutput").innerText = `OTP generado: ${otpValue}`;
                document.getElementById("otpOutput").style.display = 'block';
                showCompletionMessage();
            } catch (error) {
                console.error('Error generating OTP:', error);
                document.getElementById("otpOutput").innerText = `OTP generado: Error al generar el OTP.`;
                document.getElementById("otpOutput").style.display = 'block';
            }
        }

        window.onload = () => {
            document.getElementById("otpOutput").style.display = 'none';
        };
    </script>
</body>
</html> 